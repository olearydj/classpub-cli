## Technical Design Document: Python Port of Course Content Management CLI (Replacing `justfile`)

### Authors
- Owner: Dan O‚ÄôLeary
- Design: AI Pair (GPT), reviewed by teaching/dev stakeholders

### Version and Status
- Version: 0.1 (Draft for review)
- Target: MVP parity with current `justfile` functionality, then iterate

---

## 1. Background and Motivation

The current workflow uses a large `justfile` to manage a three-stage content system:
- `pending/` ‚Üí development workspace (keeps outputs)
- `preview/` ‚Üí local staging (gitignored, generated by sync; outputs stripped)
- Student repo (published via GitHub Actions)

The `justfile` now embeds complex, stateful logic:
- Path resolution and normalization (absolute vs relative, basename search, handling `pending/` prefixes)
- Mixed file/folder semantics (trailing slash rules, folder entries in manifest)
- Content-aware status detection (synced/modified/touched/staged/untracked/removed)
- Folder diff via `rsync -cv --dry-run`
- Interactive removal and notebook output stripping

This complexity has become brittle and hard to test in Bash. A Python CLI can provide:
- Maintainability and testability
- Cleaner abstractions (manifest, status, sync, diff)
- Cross-platform reliability
- Backward compatibility with existing repo structure and UX

---

## 2. Goals and Non‚ÄëGoals

### Goals
- Maintain functional and UX parity with `justfile`:
  - Commands: `init`, `release`/`add`, `remove`, `check`, `sync`, `diff`, `to-md`, `validate`, `clean`
  - Manifest format parity (`pending/RELEASES.txt`, trailing slash indicates folder)
  - Status icons and messages
  - Content-aware comparisons and ‚Äútouched‚Äù detection
  - Interactive removal confirmation with `--yes` override
  - Notebook output stripping in `preview/`
  - System/workflow file filtering in user-facing output
- Provide a well-structured Python CLI usable by junior/mid-level developers.
- Preserve compatibility with `CLAUDE.md`, `README.md`, and `TEST_PLAN.md`.

### Non‚ÄëGoals
- Changing repo topology or manifest format.
- Replacing GitHub Actions publishing pipeline.
- Introducing heavy new dependencies (keep minimal/optional).
- Over-optimizing performance before correctness.

---

## 3. High-Level Architecture

### Components
- CLI (Typer) orchestrates subcommands; formatted output with Rich.
- Centralized logging subsystem initialized at process start (human vs JSON formats; stderr only).
- Manifest manager for reading/writing `pending/RELEASES.txt`.
- Status engine computes per-item and folder states.
- Sync engine handles copy/update and optional removal.
- Diff engine uses Git CLI (`git diff --no-index`) for text files and `nbdime` (Python API) for notebooks.
- Conversion engine for `to-md` via `nbconvert` (Python API; required dependency).
- Validation and cleanup utilities.
 
Template adoption: Logging and Typer scaffolding are adopted verbatim from `cli-template` ([cli-template](https://github.com/olearydj/cli-template)). We will pin to a specific tag/commit for reproducibility and document it in ¬ß22. If pinning becomes fragile, we will vendor the minimal logging/CLI scaffolding into `classpub_cli/` to remove the external dependency. This document only specifies minimal project-specific deltas to avoid redundancy.

### Directory/Files
- `pending/` (source), `preview/` (staging)
- `pending/RELEASES.txt` (manifest; files and folder entries)
- System/workflow files filtered in displays: `.DS_Store`, `.gitignore`, `.gitattributes`, `RELEASES.txt`, `.ipynb_checkpoints/`

---

## 4. Technology Choices

- Python 3.10+
- CLI: Typer
- Output: Rich
- Logging: Python stdlib `logging` with `RichHandler` for human mode and a JSON formatter for CI/machine mode (stderr only); no heavy logging deps required.
- Paths: `pathlib`
- Hashing: `hashlib` (sha256). For equality, always hash when sizes are equal; do not rely on mtime; stream in chunks.
- Required libraries: `nbformat`, `nbdime`, `nbconvert`, `nbstripout` (Python APIs; no shelling out for these).
- Git CLI is required for text diffs; no dependency on `rsync`.
 
Template adoption: We do not restate cli-template logging/Typer internals here; we adopt them as-is and document only deltas (see ¬ß12.5 and ¬ß21 Phase 0).

---

## 5. Module Layout

- `classpub_cli/cli.py` (Typer app and command routing)
- `classpub_cli/logging.py` (bootstrap logging: levels, handlers, JSON vs human, stderr routing)
- `classpub_cli/config.py` (load `classpub.toml`, apply precedence with CLI flags)
- `classpub_cli/paths.py` (constants for `PENDING`, `PREVIEW`, `MANIFEST`)
- `classpub_cli/manifest.py` (read/write, normalize, dedup)
- `classpub_cli/status.py` (status computation, orphan detection)
- `classpub_cli/sync.py` (copy/update/remove, notebook stripping)
- `classpub_cli/diff.py` (file/folder diffs)
- `classpub_cli/convert.py` (`to-md`)
- `classpub_cli/validate.py` (structure checks)
- `classpub_cli/clean.py` (cleanup)
- `classpub_cli/utils.py` (filters, hashing, copy helpers, tool detection)

Rationale:
- The above list reflects clear responsibility boundaries for long-term maintainability and potential team ownership.
- For v1, we may consolidate into 4 modules (`cli`, `core`, `diff`, `utils`) to reduce initial complexity. We will split along the above boundaries once code size and change frequency justify it.
 - Logging and config are split to enable early initialization (before subcommands run) and to align with a reusable CLI template design inspired by `cli-template`.

---

## 6. Data Structures

### Manifest Entry
- `Entry` (dataclass)
  - `raw: str`  // exact manifest line (e.g., `data/` or `notebooks/01.ipynb`)
  - `rel: Path` // path relative to `pending/` (no trailing slash)
  - `is_dir: bool` // whether entry ends with `/`

### Status Enum
- `Status = { "synced", "modified", "touched", "staged", "untracked", "removed" }`

### Directory Diff Result
- `DirDiff`
  - `added: list[Path]` // in source only
  - `removed: list[Path]` // in destination only
  - `changed: list[Path]` // present in both but different content

---

## 7. Functional Specifications (Per Command)

### 7.1 `init`
- Behavior:
  - Create `pending/RELEASES.txt` with header comments if missing.
  - Idempotent; prints warning if exists.
- Output:
  - `‚úì Created pending/RELEASES.txt` or `‚ö†Ô∏è  pending/RELEASES.txt already exists`
- Exit codes: 0 on success; 0 if already exists.

### 7.2 `release <item>` (alias: `add`)
- Input:
  - `<item>` may be:
    - Absolute path under `pending/`
    - Relative path, optionally prefixed with `pending/`
    - Basename only (search both files and folders under `pending/`)
    - Folder input may be given with or without trailing slash; manifest enforces slash if folder
- Behavior:
  - Resolve uniqueness; print multiple matches with file/folder labels if ambiguous.
  - For folder entries, write with trailing `/`.
  - Prevent duplicates (exact `raw` line match).
- Output examples:
  - `‚úì Marked notebooks/01.ipynb for release`
  - `‚úì Marked data/ for release`
  - `‚ö†Ô∏è  notebooks/01.ipynb is already released`
  - `‚ùå File or folder not found: <item>`
  - On success: `Run 'classpub sync' to copy to public folder`
- On not found: print a grouped, filtered listing under `Files:` and `Folders:` (relative paths; folders have trailing `/`; two-space indentation; sorted; max 200 per group with `(+N more)` when truncated; excludes `RELEASES.txt`, `.DS_Store`, `.gitignore`, `.gitattributes`, `.ipynb_checkpoints/`).
- Exit codes: 0 on success; 1 on not found/ambiguous.

### 7.3 `remove <item>`
- Resolution identical to `release`.
- Behavior:
  - Remove exact manifest line if present.
  - If corresponding item exists in `preview/`, print hint to run `sync`.
- Output:
  - `‚úì Removed notebooks/01.ipynb from release manifest`
  - `‚úì Removed images/ from release manifest`
  - `‚ÑπÔ∏è  Item still exists in preview/ - run 'classpub sync' to remove it`
  - `‚ö†Ô∏è  <item> is not in release manifest`
- When `<item>` is not in the manifest, also echo the current manifest contents under the heading `Currently released files:` with the same filtering and formatting rules as in release-not-found (relative paths, folders with trailing `/`, one per line indented two spaces).
- Exit codes: 0 on success; 1 on manifest missing; 0 when item wasn‚Äôt present.

### 7.4 `check`
- Purpose: Show detailed repository status (files and tracked folders).
- Algorithm:
  - Build manifest list.
  - Walk `pending/` files (filter system/workflow files):
    - Determine if tracked directly or inside any tracked folder.
    - If tracked:
      - If not inside a tracked folder, show per-file status:
        - If `preview` missing ‚Üí `üìã staged`
        - Else compare:
          - If `mtime(src) > mtime(dst)` and contents equal ‚Üí `üëÜ touched`
          - If contents differ ‚Üí `üîÑ modified`
          - Else ‚Üí `‚úÖ synced`
    - Else show `üìÑ untracked`
  - For each folder entry in manifest:
    - If `preview` missing ‚Üí `üìã staged`
    - If the corresponding folder under `pending/` is missing ‚Üí `‚ö†Ô∏è  <entry>/ (missing from pending)`
    - Else compute `DirDiff(src, dst)`:
      - If any added/removed/changed ‚Üí `üîÑ modified`
      - Else ‚Üí `‚úÖ synced`
  - Orphans in `preview/`:
    - Files not listed directly AND not under any tracked folder ‚Üí `‚ö†Ô∏è removed`
    - Filter system/workflow files
  - Summary counters: Synced, Modified, Touched, Staged, Untracked, Removed
- Output: Preserve icons/wording from docs.
- Exit codes: 0 (always); purely informational.

### 7.5 `sync` [options]
- Options:
  - `--yes / -y`: auto-approve removals
  - `--dry-run`: show what would change; do not write files
- Behavior:
  - Pre-flight: if `preview/` is a symlink, exit with error and guidance.
  - Ensure `preview/` subdirectories exist as needed.
  - For each manifest entry (counts are per manifest entry, not per-file):
    - File: copy if destination missing or content differs; count the file as `updated` or `unchanged` accordingly.
    - Folder: recursively copy only changed/new files; print folder messages:
      - First-time copy: `üìÅ Copied folder <entry>/ (N files)`
      - Update with changes: `üìÅ Updated folder <entry>/ (N files)`
      - Empty folder present in `pending/`: `üìÅ Empty folder <entry>/`
  - Removal:
    - Detect files in `preview/` not tracked directly or via folder membership.
    - List to be removed; prompt unless `--yes`.
    - Prompt format (exact), printed to stdout:
      `‚ö†Ô∏è  These files will be REMOVED from preview (not in manifest):`
        - `     - path/one.txt`
        - `     - notebooks/two.ipynb`

      `  Continue with removal? [y/N] `
    - Accept `y`, `Y`, or `yes` as confirmation. Any other response skips removal and prints `  Skipped removal`.
  - Notebook outputs:
    - After copying, strip outputs in `preview/` using the `nbstripout` Python module:
      - Clear outputs and set execution counts to null for all notebooks (same policy as CI).
  - Final summary (stdout): `‚úì Sync complete: X updated, Y removed, Z unchanged` where `X` and `Z` are per-manifest-entry counts and `Y` is the number of files removed.
- Exit codes: 0 on success; 1 on permission/IO errors; 130+ on prompt abort.

### 7.6 `diff [item]`
- For non-notebook files, require Git CLI and use `git diff --no-index` to produce diffs.
- For notebooks, use `nbdime` Python API to produce notebook-aware diffs.
- No argument:
  - Header (stdout): `üìä Diff: preview vs pending (tracked files only)`
  - Iterate manifest entries:
    - Text files present in both ‚Üí `git diff --no-index preview/file pending/file` output.
    - Notebooks present in both ‚Üí `nbdime` output (not massaged; tests should not assert exact body formatting).
    - Folders present in both ‚Üí folder change summary with this schema:
      - Heading: `üìÅ <entry>/ (folder has changes)`
      - Sections (only those non-empty): `Added:`, `Removed:`, `Changed:`
      - Under each section list up to 200 relative file paths; if truncated, append a final `(+N more)` line.
  - If no diffs ‚Üí `‚úÖ No differences found between tracked files`.
- With `<item>`:
  - Resolve like `release`.
  - If file:
    - If only in `pending/` ‚Üí info message (‚Äúexists in pending but not in preview‚Äù).
    - Else produce git or notebook diff as above.
  - If folder:
    - If both exist ‚Üí same folder change summary schema as above.
    - Else ‚Üí info message.
- Exit codes: 0 even when diffs exist (informational); 1 on resolution errors.

### 7.7 `to-md`
- Purpose: Convert synchronized notebooks (from manifest) to markdown in `pending/md/...`.
- Behavior:
  - For each manifest entry:
    - File with `.ipynb` present in both `pending/` and `preview/`: convert via `nbconvert` Python API.
    - Folder: find all `.ipynb` within; convert those present in both.
  - Preserve relative directory structure under `pending/md/`.
  - Overwrite existing destination `.md` files if present; do not delete stale `.md` files in v1.
  - Report converted counts; summarize totals.
- Exit codes: 0 on success; 1 on severe errors.

### 7.8 `validate`
- Checks:
  - `pending/` exists; `preview/` may be missing (informational)
  - `pending/RELEASES.txt` exists
  - `preview/` must not be a symlink (error)
  - For each folder entry in manifest:
    - Warn if `pending` folder missing
    - If `preview` folder exists, optionally check content parity (lightweight)
    - Warn if `preview/<entry>/` is missing while folder is in manifest
  - Orphaned preview folders:
    - If a folder exists in `preview/` that is not tracked directly or via folder membership, emit a warning
  - Mixed-platform path formats: warn on Windows-style separators (`\\`) found in manifest on non-Windows hosts (or vice versa) and suggest normalizing to `/`.
  - Optional check: presence of `.github/workflows/publish-public.yml` (warn only)
  - Warnings: potential case-collisions under case-insensitive FS; presence of `.ipynb_checkpoints/` under `pending/`.
- Output: `‚úÖ` for passes; `‚ùå` for missing criticals; `‚ö†Ô∏è` for warnings
- Exit codes: 0 on pass; 1 on critical structural failures.

### 7.9 `clean`
- Behavior:
  - Recursively remove `.DS_Store` files
  - Recursively remove `.ipynb_checkpoints` directories
  - Print counts
- Exit codes: 0 always unless IO errors.

---

## 8. Detailed Algorithms

### 8.1 Path Resolution (shared by `release/remove/diff`)
- Accept absolute or relative paths.
- Absolute paths must resolve under `pending/` or error out.
- If provided path starts with `pending/`, strip prefix for manifest canonicalization.
- If item not found as exact path:
  - Find all matches by basename across files and directories.
  - If multiple matches ‚Üí list with `(file)`/`(folder)` labels and exit.
  - Cap ambiguity listing at 50 entries; if more matches exist, append a final line: `(+N more)`.
  - If single match ‚Üí select.
- Folder entries in manifest must end with `/`.
- Prevent duplicates by exact `raw` line match.
 - Path separator policy: manifest lines always use forward slashes (`/`). Inputs using platform separators are normalized to `/` for matching.
 - Unicode policy: store and display original paths exactly; compute a comparison key using NFC normalization for matching only (no rewriting on disk or in the manifest).

### 8.2 Content Comparison
- `files_equal(a, b)`:
  - If sizes differ ‚Üí different.
  - Otherwise compute SHA-256 hash and compare (streamed, fixed chunk size).
- ‚ÄúTouched‚Äù detection:
  - If `mtime(src) > mtime(dst)` and contents equal ‚Üí `touched`.
- Directory diff:
  - Enumerate file lists relative to roots and compute set differences.
  - `added = src_only`, `removed = dst_only`, `changed = {both | content_diff}`

```python
def dir_diff(src: Path, dst: Path) -> DirDiff:
    """Recursively compare directories without following symlinks.
    - Walk src and dst with os.walk(followlinks=False)
    - Build sets of relative file paths (skip symlinks and ignored files)
    - For files in both, compare with files_equal()
    - Return DirDiff(added, removed, changed)
    On permission errors: warn and treat directory as modified.
    """
```

### 8.3 Sync Strategy
- Files:
  - If destination missing ‚Üí copy
  - Else if `files_equal` false ‚Üí copy
  - Else count as `unchanged`
- Folders:
  - Iterate source files; ensure parent dirs in `preview/`; apply file strategy
- Removals:
  - Scan `preview/` for files not tracked (not in manifest; not under any tracked folder)
  - Prompt to remove; remove files only (skip symlinks)
  - After removals, prune empty directories under `preview/` (logged, not printed)
- Notebook strip:
  - Use `nbstripout` Python API to clear outputs and execution counts for all notebooks in `preview/` (matches CI policy).

### 8.5 Interrupted Operation Recovery
- Create `.sync-in-progress` marker at the start of `sync`; remove on successful completion.
- If a previous marker is found, warn and offer a full resync of all tracked content.
- Combine with stale-lock handling (see ¬ß12.5) to recover from crashes without manual cleanup.
 - If `--yes` is provided and the marker is stale, proceed with full resync without an additional prompt; otherwise prompt the user.

### 8.4 Filters
- Ignore in displays and orphan scans:
  - Files: `.DS_Store`, `.gitignore`, `.gitattributes`, `RELEASES.txt`
  - Directories: `.ipynb_checkpoints`
- Skip symlinks during removal.
 - Ignore pattern semantics:
   - Patterns are simple globs evaluated relative to roots; trailing `/` indicates directories.
   - Negation patterns (e.g., `!pattern`) are not supported in v1.

---

## 9. CLI/UX and Output

- Icons and wording match current docs:
  - `‚úÖ synced`, `üëÜ touched`, `üîÑ modified`, `üìã staged`, `üìÑ untracked`, `‚ö†Ô∏è removed`
- Color via Rich (green/yellow/red/blue as appropriate)
- `--yes` and `--dry-run` on `sync`
- Consistent relative paths in output (no absolute paths)
- Keep messages used in docs/tests stable for parity
- Global options (applied before subcommands):
  - `-v/--verbose` (increase log verbosity; cumulative), `-q/--quiet` (decrease verbosity)
  - `--log-format [human|json]` (human uses Rich; JSON is machine-readable)
  - `--log-level [error|warning|info|debug]` (overrides computed console level)
  - `--no-color` (disable Rich color/styling)
- Logging policy:
  - User-facing command output goes to stdout via Rich.
  - Logs go to stderr only, never mixed into stdout. JSON mode is newline-delimited objects.
  - In JSON log mode or when `--no-color`, disable Rich styling to keep outputs parseable.
  - A file log is always written at ‚â• INFO level to a platform-specific user log directory (per `cli-template`, via appdirs/platformdirs).
  - Log file rotation is handled by the host system (e.g., logrotate/journald); no in-app rotation in v1.
  - File logs use JSON format; console default level is INFO in development and WARNING (or ERROR) in production; configurable via flags.
 - Final result policy:
### 9.1 Final Output Per Command
- `check`: final stdout is the status listing and a one-line summary. Traversal/progress in logs.
- `sync`: final stdout is `‚úì Sync complete: X updated, Y removed, Z unchanged`. The removals listing and the interactive prompt both appear on stdout; progress/details remain in logs (stderr).
- `diff`: final stdout is diff output (git/nbdime) or `‚úÖ No differences‚Ä¶`. Discovery/progress in logs.
- `to-md`: final stdout is a conversion summary (counts).
- `validate`/`clean`: final stdout is result summary lines; details in logs.
   - All progress/details/diagnostics are emitted as logs (stderr) according to the current log level.
   - The command‚Äôs final result is printed once to stdout after logging completes (no interleaving).
   - No duplication: content must appear either as logs (stderr) or as final result (stdout), never both.
 
Unless explicitly listed as a delta above, global options and logging behavior follow `cli-template` verbatim.

---

## 10. Error Handling and Exit Codes

- Resolution errors (not found, ambiguous) ‚Üí 1
- IO/permission errors ‚Üí 1 (with clear path in message)
- Informational commands (`check`, `diff` without errors) ‚Üí 0
- Prompt declines:
  - If user answers not `y`/`Y`, treat as cancel and continue without removals (exit 0)
  - If user sends Ctrl-C/EOF during a prompt, exit 130 without performing removals

---

## 11. Performance Considerations

- Use size as an initial filter; when sizes match, compute a streamed SHA-256 to verify equality.
- Stream in chunks to limit memory usage on large files.
- Folder diff uses relative path sets to avoid redundant traversal.
- Optional future: parallel hashing for large folders (ThreadPool), behind feature flag.
- Avoid external `rsync`; fully Python for portability.

### 11.1 Targets and Measurement (initial, non-blocking)
- Targets (on modern SSD CI runners; adjust after baseline):
  - Check: 1000 files (1KB‚Äì10MB) completes < 5s
  - Sync: 1000 files (1KB‚Äì10MB) completes < 10s
  - Hash throughput: > 100 MB/s sustained
  - Memory: < 100 MB RSS for files up to 1 GB
- Methodology:
  - Use synthetic fixture generators and time with `time.perf_counter()` around CLI calls
  - Capture and log file counts, sizes, elapsed times; emit JSON logs for CI parsing
  - Fail tests only if regressions exceed a tolerance when the perf gate env var is enabled; otherwise warn

---

## 12. Security and Safety

- For absolute input paths, enforce containment within `pending/`.
- Never follow symlinks for removal; skip symlinks in `preview/`.
- Only touch `preview/` and `pending/md/` for writes.
- Always prompt before destructive removal unless `--yes`.
 - The current working directory must be the repository root (contains `pending/`). If not, exit with guidance.

### 12.5 Configuration and Concurrency
- Configuration scope and precedence:
  - Only CLI flags and project-local `classpub.toml` are supported.
  - Precedence: CLI flags > classpub.toml > compiled defaults.
- `classpub config init` scaffolds a fully commented `classpub.toml` template explaining all options and defaults.
- No user-level config or `pyproject.toml` integration at this time.
- Concurrency:
  - Single-writer lock (fail-fast) for write operations (`sync`, `clean`). If a lock exists, exit with a distinct code and explain how to clear or wait.
  - Lock details:
    - Lock file at repo root, e.g., `.classpub.lock`, created with O_EXCL semantics.
    - Contents: PID, hostname, timestamp (UTC ISO8601).
    - On contention: if owning PID is not alive and timestamp older than TTL (default 30s), treat as stale and remove, then proceed; otherwise exit immediately.
    - No wait/retry loop (deterministic behavior).
 - Locking enhancement plan:
   - Phase 3: supplement O_EXCL with process-held advisory locking (`fcntl.flock` on POSIX; `msvcrt` on Windows) via a thin abstraction; auto-release on process death. If portability issues arise, consider `portalocker` as an optional dependency.
 - Config validation:
   - Validate types and bounds on load; fail fast with actionable messages:
     - `[sync.large_file_warn_mb] >= 0`
     - `[logging.level] in {ERROR, WARNING, INFO, DEBUG}` (case-insensitive)
     - `[logging.format] in {human, json}`
     - `[hash.chunk_size] >= 1024`
     - `[ignore.patterns]` is a list of non-empty strings

Example `classpub.toml` schema:
```toml
# classpub.toml

[general]
# strict = false      # Treat warnings (symlinks, bad names) as errors.
# assume_yes = false  # Auto-confirm destructive prompts (e.g., sync removals).
# color = true        # Enable colored human output via Rich (overridden by --no-color).

[sync]
# dry_run = false            # Compute the plan without writing.
# large_file_warn_mb = 100   # Warn when hashing files larger than this size (MB).

[ignore]
# patterns = [
#   ".DS_Store",
#   ".gitignore",
#   ".gitattributes",
#   ".ipynb_checkpoints/",
#   "RELEASES.txt",
# ]

[hash]
# chunk_size = 8192   # Streaming chunk size in bytes for hashing.

[logging]
# level = "INFO"      # One of: ERROR, WARNING, INFO, DEBUG (file logs are always ‚â• INFO)
# format = "human"    # One of: human, json (overridden by --log-format)
# timestamps = true    # Include timestamps in logs (JSON always includes ISO8601)
```

---

## 13. Migration Plan

1. Implement Python CLI with `init`, `add/release`, `remove`, `check`.
2. Add `sync` with removal prompt and notebook stripping.
3. Add `diff`, `to-md`, `validate`, `clean`.
4. Transitional `justfile` that proxies:
   - `just add X` ‚Üí `classpub add X`, etc.
   - Removes bash complexity while preserving developer muscle memory.
5. Update docs (`README.md`, `CLAUDE.md`) to prefer Python CLI.
6. Port `TEST_PLAN.md` scenarios to pytest integration tests.
7. After stabilization, retire complex `justfile` content.

---

## 14. Test-Driven Development (TDD) Strategy

### 14.1 Approach and Principles
- Write tests first for each behavior specified by the current `justfile` and `TEST_PLAN.md`.
- Implement the minimal code to pass those tests, then refactor (Red ‚Üí Green ‚Üí Refactor).
- Use small, behavior-focused tests that assert observable CLI output and file-system effects (no private API coupling).
- Keep test messages and icons stable to lock UX parity.
 - Test docstrings and/or comments should reference relevant TDD sections (e.g., `¬ß7.5`, `¬ß8.3`, `¬ß9.1`, `¬ß10`) for traceability.

### 14.2 Test Suite Layout
- `tests/`
  - `conftest.py` (shared fixtures, markers)
  - `helpers.py` (filesystem creators, manifest writers, CLI runner utils)
  - `test_cli_globals.py` (verbosity flags, log format switching, color disable)
  - `test_cli_init.py`
  - `test_cli_release_remove.py`
  - `test_cli_check.py`
  - `test_cli_sync.py`
  - `test_cli_diff.py`
  - `test_cli_to_md.py`
  - `test_cli_validate.py`
  - `test_cli_clean.py`
  - `test_path_resolution.py`
  - `test_status_engine.py`
  - `test_sync_engine.py`

### 14.3 Core Fixtures
- `tmp_repo(tmp_path)`: creates isolated working dir with `pending/`, empty `preview/` (optional), and chdir into it.
- `write_manifest(tmp_repo)`: helper to create or append to `pending/RELEASES.txt` with proper formatting.
- `fs_tree(tmp_repo)`: utility to create files/folders as used in `TEST_PLAN.md` (notebooks, data, images, etc.).
- `cli_runner()`: Typer `CliRunner` wrapper to invoke commands synchronously and capture output/exit codes.
- `tool_availability(monkeypatch)`: stubs tool detection (e.g., `nbstripout`, `nbconvert`) to test both presence and absence paths.
- `freeze_time/mtime_helpers`: convenience to simulate touched vs modified cases predictably.
- `capture_streams`: helper to capture stdout vs stderr separately to assert separation of user output and logs.

### 14.4 Markers and Grouping
- `@pytest.mark.slow`: heavy directory hashing scenarios.
- No optional-tool markers; required deps are installed in CI.

### 14.5 Mapping to `TEST_PLAN.md`
- Recreate all numbered scenarios as automated tests using temporary directories:
  - Initialization (1), Status checks (2,4,6), Release variants (3), Sync behavior (5), Touched vs Modified (7‚Äì8),
    Folder updates (9, 9.5), Filtering (9.6), Removals (10), Diff (11), Validate (12), Clean (13),
    Mixed workflows (14), Edge cases (15‚Äì19), Full cycle (20).
- Additional unit tests:
  - Path resolution (pending prefix, absolute under pending, basename disambiguation)
  - Manifest serialization and dedup
  - `files_equal` on large/same-size files
  - Orphan detection with tracked folders

### 14.10 Additional Tests (clarified behaviors)
- Release/add not-found listing prints grouped Files/Folders with filters; sorted; truncated with `(+N more)`.
- Remove when item absent prints `Currently released files:` list as per filters.
- Check warns `‚ö†Ô∏è  <entry>/ (missing from pending)` for manifest folders missing in `pending/`.
- Sync counts are per-manifest-entry; folder messages include `Copied/Updated/Empty folder ‚Ä¶ (N files)`; final summary matches counts.
- Removal prompt exact text, acceptance of `y`/`Y`/`yes`, decline prints `Skipped removal` and exits 0; prompt printed to stdout.
- Diff folder summary schema (Added/Removed/Changed) with truncation at 200 items and `(+N more)`; headers printed.
- Validate warns on missing preview subfolders for manifest folders and on orphaned preview folders.
- Locking stale-TTL behavior and contention exit code covered in `test_locking.py`.
- Hashing large-file warning threshold behavior from config `[sync.large_file_warn_mb]`.
- Repo-root enforcement error when not run from repository root.
- Path resolution NFC normalization and support for spaces in paths.

### 14.6 Sample Tests (Illustrative)
```python
# tests/test_cli_init.py
def test_init_creates_manifest(cli_runner, tmp_repo):
    result = cli_runner(["init"])  # classpub init
    assert result.exit_code == 0
    assert (tmp_repo / "pending/RELEASES.txt").exists()
    assert "Created pending/RELEASES.txt" in result.stdout

def test_init_idempotent(cli_runner, tmp_repo):
    (tmp_repo / "pending").mkdir(exist_ok=True)
    (tmp_repo / "pending/RELEASES.txt").write_text("# Released Files\n\n")
    result = cli_runner(["init"])
    assert result.exit_code == 0
    assert "already exists" in result.stdout
```

```python
# tests/test_cli_globals.py
def test_global_verbose_and_quiet_affect_log_level(cli_runner, capture_streams):
    result = cli_runner(["--verbose", "--verbose", "init"])  # INFO -> DEBUG
    assert result.exit_code == 0

    result2 = cli_runner(["--quiet", "check"])  # INFO -> WARNING
    assert result2.exit_code == 0

def test_log_format_json_writes_logs_to_stderr_only(cli_runner, capture_streams, tmp_repo):
    res = cli_runner(["--log-format", "json", "check"])  # emits logs to stderr
    assert res.exit_code == 0
    # stdout contains user-facing lines, stderr contains JSON logs (lines start with '{')
    assert "{" in res.stderr or "}\n" in res.stderr

def test_warning_console_level_hides_info_but_file_has_info(cli_runner, capture_streams, tmp_repo, tmp_path):
    # Simulate production: console WARNING, file at INFO
    res = cli_runner(["--log-level", "warning", "check"])  # console hides INFO
    assert res.exit_code == 0
    # stderr may be empty or contain warnings/errors only
    # stdout still contains final result
    assert res.stdout != ""
```

```python
# tests/test_cli_check.py (touched vs modified)
def test_check_touched_vs_modified(cli_runner, tmp_repo, fs_tree, write_manifest):
    # create file and preview copy
    src = tmp_repo / "pending/notebooks/hello.py"
    src.parent.mkdir(parents=True, exist_ok=True)
    src.write_text('print("Hello World")\n')
    write_manifest(["notebooks/hello.py"])  # tracked file

    # first sync to create preview
    cli_runner(["sync", "--yes"])  # assume implementation uses content-copy

    # modify then revert (simulate touched)
    src.write_text('print("Modified")\n')
    src.write_text('print("Hello World")\n')

    result = cli_runner(["check"])
    assert "üëÜ notebooks/hello.py (touched)" in result.stdout
```

### 14.7 Coverage Targets
- Overall project coverage: ‚â• 90% lines/branches.
- Critical modules coverage: ‚â• 95% for `manifest`, `status`, and `sync`.
- Coverage exclusions (narrow and explicit):
  - Typer command wiring and option parsing glue in `cli.py`
  - `main()` entrypoint shim and version banner
  - Auto-generated help/argument validation code from Typer
  All behavior, I/O, and error paths in commands and engines remain covered.

### 14.8 CI Pipeline (High-Level)
- Single pipeline on Linux + macOS: install required deps (`nbformat`, `nbdime`, `nbconvert`, `typer`, `rich`), then run `pytest -q --cov=classpub_cli --cov-report=xml`.
- Upload coverage to summary; enforce thresholds via `coverage xml` and a quality gate step.

### 14.9 Developer Workflow (Per Command)
1) Write/enable tests for the next smallest behavior (from `TEST_PLAN.md`).
2) Run tests to confirm failure (Red).
3) Implement minimal feature code (Green).
4) Refactor code/tests for clarity without changing behavior (Refactor).
5) Repeat until command parity is reached; move to next command.

---

## 15. Implementation Sketch (Key Functions)

### `manifest.read_manifest()`
References: ¬ß7.2 (manifest format), ¬ß8.1 (path resolution), ¬ß8.4 (filters)
```python
def read_manifest() -> list[Entry]:
    if not MANIFEST.exists():
        return []
    entries: list[Entry] = []
    for line in MANIFEST.read_text().splitlines():
        s = line.strip()
        if not s or s.startswith("#"):
            continue
        is_dir = s.endswith("/")
        rel = Path(s[:-1] if is_dir else s)
        entries.append(Entry(raw=s, rel=rel, is_dir=is_dir))
    # Deduplicate while preserving order
    seen = set(); result = []
    for e in entries:
        if e.raw not in seen:
            seen.add(e.raw); result.append(e)
    return result
```

### `utils.files_equal(a, b)`
References: ¬ß8.2 (content comparison), ¬ß11 (performance), ¬ß16 (hashing deps)
```python
def files_equal(a: Path, b: Path) -> bool:
    sa, sb = a.stat(), b.stat()
    if sa.st_size != sb.st_size:
        return False
    # Sizes equal: compute content hash to verify equality
    return sha256_file(a) == sha256_file(b)
```

### `status.compute()`
References: ¬ß7.4 (status rules), ¬ß8.2 (touched logic, dir diff), ¬ß8.4 (filters), ¬ß9.1 (output)
```python
# Pseudocode outline
for file in walk(pending):
    if ignored(file): continue
    tracked_direct = any(e.rel == rel and not e.is_dir for e in entries)
    tracked_by_folder = any(e.is_dir and rel.is_relative_to(e.rel) for e in entries)
    if tracked_direct:
        if not tracked_by_folder:
            decide_status_by_preview_and_content()
    else:
        print_untracked()

for folder_entry in entries if e.is_dir:
    if preview_missing: staged
    else:
        added, removed, changed = dir_diff(src, dst)
        print modified or synced accordingly

scan_preview_for_orphans()
```

### `sync.run(--yes, --dry-run)`
References: ¬ß7.5 (behavior, prompts, counts), ¬ß8.3 (sync strategy), ¬ß9.1 (stdout/stderr), ¬ß10 (exit codes)
```python
# Pseudocode outline
for entry in manifest:
    if entry.is_dir: sync_folder(entry)
    else: sync_file(entry)

to_remove = compute_orphans_in_preview()
if to_remove:
    prompt unless --yes
    if confirmed: remove

strip_notebooks_in_preview()  # nbstripout preferred; py fallback
```

---

## 16. Dependencies

- Required Python libraries: `typer`, `rich`, `nbformat`, `nbdime`, `nbconvert`, `nbstripout`
- Required CLI: `git` (for text diffs). No reliance on `rsync`.
- Update `pyproject.toml`:
  - Add `typer[all]`, `rich`, `nbformat`, `nbdime>=3,<4`, `nbconvert>=7,<8`, `nbstripout>=0.6`
  - Keep `classpub = "classpub_cli.cli:main"` as entry point; route `main()` to Typer app.
  - On `diff` startup, verify Git version ‚â• 2.20 and fail with a clear message if unmet.

---

## 17. Risks and Mitigations

- Behavior drift vs `justfile`:
  - Mitigation: reuse messages, icons, and acceptance tests from `TEST_PLAN.md`.
- Performance on large folders:
  - Mitigation: mtime/size short-circuit; optional parallel hashing later.
- Tool availability variations:
  - Mitigation: runtime detection; informative warnings; safe fallbacks.
- Cross-platform differences:
  - Mitigation: pure Python for file ops; avoid `rsync`.

---

## 18. Open Questions

- Should we expose a `--json` output mode for status (future automation)?
- Windows/WSL official support level?

---

## 19. Acceptance Criteria

- All commands functionally match current behavior and messages from `README.md`, `CLAUDE.md`, and `TEST_PLAN.md`.
- Full pass of automated tests mirroring `TEST_PLAN.md`.
- Transitional `justfile` proxies to the Python CLI successfully.
- Stakeholder review of UX parity (icons, phrasing) signed off.
 - Logging verified: stdout only for user-facing messages, stderr only for logs; JSON mode produces NDJSON; global flags adjust level/format; color control respected.
 - Logging and Typer behavior conform to `cli-template` with no drift beyond the deltas documented in this TDD.
 - Final result policy enforced: console level controls verbosity; no interleaving/duplication; file logs always at ‚â• INFO.

---

## 20. Timeline (Rough)

- Week 1: `init`, `add/remove`, `check`, manifest handling, tests
- Week 2: `sync` (copy + prompt + strip), tests
- Week 3: `diff`, `to-md`, `validate`, `clean`, tests
- Week 4: Transitional `justfile`, docs, polish, performance passes

---

## 21. Phased Implementation Plan

### Phase 0 ‚Äî Bootstrap and Test Harness
- Scope:
  - Project skeleton (initial `cli`, `core`/`utils` modules) and Typer entrypoint wired to `classpub`.
  - Dependency checks for `nbformat`, `nbdime`, `nbconvert`, `nbstripout`; Git CLI (>= 2.20) check for `diff`.
  - Adopt `cli-template` logging and Typer scaffolding verbatim; wire `project.scripts.classpub` to the Typer app.
  - Project-specific deltas only: config precedence (CLI > `classpub.toml` > defaults), and use of project-local `classpub.toml` only.
  - Enforce log/output separation policy: logs (stderr) for all progress; single final result to stdout.
  - Always-on rotating file logs at ‚â• INFO; console default INFO (dev) and WARNING/ERROR (prod).
- Tests:
  - `test_cli_init.py::test_init_creates_manifest`, `test_init_idempotent`.
  - `test_cli_validate.py::test_required_deps_and_git_checks` (new).
  - `test_cli_globals.py` (assert stdout/stderr separation and flags as in `cli-template`; only verify deltas if differing; console WARNING hides INFO while file remains at INFO).
- Exit criteria: CLI runs; `init` prints expected output; clear failures when deps are missing.

### Phase 1 ‚Äî Manifest + Path Resolution
- Scope:
  - `release/add`, `remove`; canonicalization (relative-to-`pending`, folder trailing slash, de-dup).
  - Absolute path containment; basename disambiguation; Unicode normalization (NFC) for matching only.
- Tests:
  - `test_cli_release_remove.py` (all variants, duplicates, ambiguity).
  - `test_path_resolution.py` (absolute, `pending/`-prefixed, basename, folder entries, NFC).
- Exit criteria: Manifest entries exactly as specified; outputs/icons match.

### Phase 2 ‚Äî Status Engine
- Scope:
  - `files_equal` (size filter + streamed SHA-256), ‚Äútouched‚Äù via mtime, ignore patterns, orphan detection.
  - `dir_diff` (recursive, no symlinks; warn on permission errors ‚Üí mark modified).
- Tests:
  - `test_cli_check.py` (synced/modified/touched/staged/untracked/removed).
  - `test_status_engine.py` (dir_diff edge cases, permission warnings).
- Exit criteria: Status summaries and per-item lines match spec; ignores applied.

### Phase 3 ‚Äî Sync Engine Core
- Scope:
  - Copy/update (atomic writes), create `preview/` structure; unchanged detection; dry-run parity.
  - Removal plan + prompt (exact format); single-writer lock; `.sync-in-progress` marker and recovery.
  - Introduce advisory locking abstraction (`fcntl.flock`/`msvcrt`) in addition to O_EXCL; auto-release on process death.
- Tests:
  - `test_cli_sync.py` (added/updated/unchanged, removal prompt, `--yes`, dry-run parity).
  - `test_locking.py` (lock contention and stale lock TTL handling).
- Exit criteria: Deterministic sync plan and results; no racey writes; proven dry-run parity.

### Phase 4 ‚Äî Notebook Stripping (Preview)
- Scope:
  - Use `nbstripout` Python API to clear outputs and execution counts across `preview/**/*.ipynb`.
- Tests:
  - `test_cli_sync.py::test_notebook_outputs_stripped` (execution counts null, outputs empty arrays).
- Exit criteria: Preview notebooks match CI stripping policy.

### Phase 5 ‚Äî Diff Command
- Scope:
  - Text diffs via `git diff --no-index`; notebook diffs via `nbdime`; folder summary; pending-only info.
  - Enforce Git version check (>= 2.20) at command start.
- Tests:
  - `test_cli_diff.py` (text file diff, notebook diff, folder summary, pending-only messages).
- Exit criteria: Output aligns with git/nbdime expectations; clear messages otherwise.

### Phase 6 ‚Äî to-md Conversion
- Scope:
  - Use `nbconvert` Python API; write to `pending/md/...` preserving structure.
- Tests:
  - `test_cli_to_md.py` (file and folder cases; output paths and counts).
- Exit criteria: Deterministic markdown generation; correct relative destinations.

### Phase 7 ‚Äî Validate and Clean
- Scope:
  - `validate`: preview-as-symlink hard error; malformed manifest; missing paths; case-collision warning.
  - `clean`: `.DS_Store` and `.ipynb_checkpoints` removal with counts.
- Tests:
  - `test_cli_validate.py` (symlink detection, manifest issues, missing preview folder).
  - `test_cli_clean.py` (counts and removal across tree).
- Exit criteria: Clear diagnostics and non-zero exit on structural failures.

### Phase 8 ‚Äî Config Init and Loading
- Scope:
  - `classpub config init` generates fully commented `classpub.toml`.
  - Config precedence: CLI flags > `classpub.toml` > defaults.
  - Implement MVP keys: `[general.strict]`, `[general.assume_yes]`, `[ignore.patterns]`.
- Tests:
  - `test_config_init.py` (template content correctness).
  - `test_cli_sync.py::test_assume_yes_from_config`.
  - `test_cli_check.py::test_custom_ignore_patterns`.
- Exit criteria: Config reliably overrides defaults; template is self-documenting.

### Phase 9 ‚Äî CI and Coverage Gates
- Scope:
  - CI runs on macOS+Linux; installs required deps; `pytest --cov` with thresholds.
  - Optional lightweight performance smoke test (skipped unless env-var set).
- Tests:
  - Pipeline green; coverage ‚â• 90% overall, ‚â• 95% for `manifest`, `status`, `sync`.
- Exit criteria: CI stable, coverage enforced.

### Phase 10 ‚Äî Migration & Transitional justfile
- Scope:
  - Add transitional `justfile` that proxies to the Python CLI; document rollback/tag.
- Tests:
  - Optional CI smoke that invokes proxies; manual verification accepted.
- Exit criteria: Dev muscle memory preserved; documented rollback path.

### Per‚Äëphase acceptance checklist
- All phase-specific unit/integration tests pass locally and in CI.
- User‚Äëvisible messages/icons match TDD exactly (asserted).
- Exit codes per TDD enforced (asserted).
- No regressions in previously completed phases (full suite stays green).

### How to run tests per phase
- All: `pytest -q --cov=classpub_cli --cov-report=term-missing`.
- Focus by keyword (Phase 1 example): `pytest -q -k "init or release or remove"`.
- Verify lock/IO tests on both macOS and Linux CI runners.

---

## 22. References

- cli-template (source for logging and Typer scaffolding): [cli-template](https://github.com/olearydj/cli-template)
  - Pinned version: commit `553817c53bf9ea592620d7beb5f44801bc5e2020` (2025-08-10, "uv run for pytest in justfile"). See commit [553817c](https://github.com/olearydj/cli-template/commit/553817c53bf9ea592620d7beb5f44801bc5e2020). If the pin becomes unavailable, fall back to vendored scaffolding per ¬ß3.
